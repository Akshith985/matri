/**
 * # Firestore Security Rules: BloomCare Application
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model, often referred to as a "user data silo".
 * All user-specific data, including profiles and health dashboards, is private and can only be
 * accessed by the authenticated user who owns it. There is no concept of public data or
 * cross-user access in this model.
 *
 * ## Data Structure
 * The data is organized hierarchically to facilitate simple and secure rules. All data
 * related to a specific user is nested under a top-level path: `/users/{userId}`. This structure
 * makes the user's UID the primary key for authorization, allowing for efficient and secure
 * access control without needing to read other documents.
 *
 *   /users/{userId}/
 *     ├─ userProfiles/{userProfileId}
 *     └─ healthDashboards/{healthDashboardId}
 *
 * ## Key Security Decisions
 * - **Strict Ownership**: A user can only read or write documents within their own `/users/{userId}` data tree.
 * - **No Public Listing**: Listing users or any other top-level collection is explicitly disallowed to protect user privacy.
 * - **Path-Based Security**: Authorization is primarily derived from the `{userId}` wildcard in the document path, ensuring that a user's identity is always checked against the data they are trying to access.
 * - **Relational Integrity**: On creation, rules validate that the `userId` field within a UserProfile document matches the `userId` in the path, ensuring data consistency from the start. This field is then enforced as immutable.
 *
 * ## Developer Note on `auth/configuration-not-found`
 * The user-reported error `auth/configuration-not-found` is a client-side Firebase Authentication setup issue, not a Security Rules problem. It indicates that an authentication method (e.g., Email/Password) has not been enabled in the Firebase Console for your project. Please enable the required sign-in providers in the Firebase Console -> Authentication -> Sign-in method tab. These rules will correctly secure the database once the client-side authentication is configured properly.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================================================
    // Helper Functions
    // =====================================================================

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the core function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the user is the owner and the document already exists.
     * Crucial for preventing modification or deletion of non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * Ensures that if a field is being updated, it remains unchanged.
     */
    function isFieldImmutable(fieldName) {
      return !(fieldName in request.resource.data) || request.resource.data[fieldName] == resource.data[fieldName];
    }

    // =====================================================================
    // Collection Rules
    // =====================================================================

    /**
     * @description Secures a user's private profile document. Only the owner can perform any action on their own profile.
     * @path /users/{userId}/userProfiles/{userProfileId}
     * @allow (get) A logged-in user ('user_abc') can read their own profile at `/users/user_abc/userProfiles/profile_123`.
     * @deny  (get) A logged-in user ('user_xyz') CANNOT read another user's profile at `/users/user_abc/userProfiles/profile_123`.
     * @principle Restricts access to a user's own data tree and validates relational integrity.
     */
    match /users/{userId}/userProfiles/{userProfileId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && isFieldImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures a user's private health dashboard. Only the owner can access their own health data.
     * @path /users/{userId}/healthDashboards/{healthDashboardId}
     * @allow (create) A logged-in user ('user_abc') can create their dashboard at `/users/user_abc/healthDashboards/dash_456`.
     * @deny  (update) An anonymous user CANNOT update any dashboard.
     * @principle Restricts access to a user's own data tree, ensuring sensitive health data remains private.
     */
    match /users/{userId}/healthDashboards/{healthDashboardId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

  }
}
